<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Business Card</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg fill=%22none%22 stroke=%22currentColor%22 viewBox=%22 0 0 24 24%22 xmlns=%22http://www.w3.org/2000/svg%22><path stroke-linecap=%22round%22 stroke-linejoin=%22round%22 stroke-width=%22 2 %22 d=%22 M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z%22></path></svg>">
        <!-- 引入html2canvas -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <!-- 在<head>中添加viewport meta标签 -->
    <meta name="viewport" content="width=device-width, initial-scale=0.7, maximum-scale=0.7, user-scalable=no">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px 0;
            font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;
            background: linear-gradient(135deg, #fff0f5 0%, #f0f8ff 100%);
            transition: all 0.3s;
        }

        body.dark {
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
        }

        .window {
            width: 480px;
            min-height: 120px; /* 最小高度 */
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(255,182,193,0.3);
            margin: 20px 0;
            border: 0px solid #ffb3d9;
            transition: all 0.3s;
            overflow: hidden;
        }

        body.dark .window {
            background: #333;
            border-color: #666;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .titlebar {
            height: 40px;
            background: linear-gradient(90deg, #ffb3d9 0%, #a2d2ff 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 20px;
            position: relative;
            z-index: 1;
            border-radius: 0px 0px 0 0;
        }

        body.dark .titlebar {
            background: linear-gradient(90deg, #666 0%, #444 100%);
        }

        .controls {
            position: absolute;
            left: 20px;
        }

        .control {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            cursor: pointer;
            display: inline-block;
        }

        .close { background: #ff4f4f; }
        .minimize { background: #ffdb39; }
        .maximize { background: #6ae739; }

        .filename {
            color: #fff;
            font-size: 18px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .editor {
            display: flex;
            padding: 0px 0px 20px 0px;
        }

        .line-numbers {
            width: 50px;
            padding-right: 10px;
            padding-top:10px;
            background: #fff5f8;
            text-align: right;
            border-right: 2px solid #ffe6ee;
        }

        body.dark .line-numbers {
            background: #2a2a2a;
            border-color: #3a3a3a;
        }

        .line-number {
            color: #666;
            font-weight: bold;
            padding-right: 10px;
            line-height: 24px;
            height: 24px;
        }

        body.dark .line-number {
            color: #999;
        }

        .code-content {
            flex: 1;
            padding: 0 20px;
            padding-top: 10px;
            overflow: visible; /* 移除滚动条 */
        }

        .json-line {
            line-height: 24px;
            min-height: 24px;
            white-space: pre-wrap; /* 允许自动换行 */
            word-break: break-all;
            text-rendering: optimizeLegibility; /* 优化字体渲染 */
            -webkit-font-smoothing: subpixel-antialiased; /* Mac优化 */
        }

        .json-key { color: #ff6b6b; }
        .json-string { color: #6c5ce7; }
        .json-bracket { color: #666; }
        .json-number { color: #00cecb; }
        .json-boolean { color: #ff8c00; }
        .json-colon { color: #666; margin: 0 3px; }
        body.dark .json-colon { color: #999; }

        .indent-1 { padding-left: 20px; }
        .indent-2 { padding-left: 40px; }

        .theme-toggle {
            padding: 10px 20px;
            border-radius: 20px;
            border: 2px solid #ffb3d9;
            background: #fff;
            cursor: pointer;
            font-family: inherit;
            font-size: 16px;
            margin-top: 20px;
            transition: all 0.3s;
        }

        body.dark .theme-toggle {
            background: #444;
            border-color: #666;
            color: #fff;
        }
        .input-container {
            width: 480px;
            margin: 20px 0;
            padding: 15px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        body.dark .input-container {
            background: #333;
        }

        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .input-group {
            flex: 1;
            display: flex;
            gap: 10px;
        }

        input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #ffb3d9;
            border-radius: 8px;
            font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace
        }

        body.dark input {
            background: #444;
            border-color: #666;
            color: #fff;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        button {
            cursor: pointer;
            transition: all 0.3s;
        }

        .add-btn {
            padding: 8px 20px;
            background: #ffb3d9;
            border: none;
            border-radius: 8px;
        }

        .remove-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 5px;
            width: 30px;
        }
                /* 新增字体和语法高亮样式 */
        .code-content {
            font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace;
            font-weight: 600; /* 加粗字体 */
        }

        /* 增强语法高亮 */
        .json-key { 
            color: #ff6b6b;
            font-weight: 700; /* 特别加粗 */
            text-rendering: optimizeLegibility; /* 优化字体渲染 */
            -webkit-font-smoothing: subpixel-antialiased; /* Mac优化 */
        }
        .json-string { 
            color: #6c5ce7;
            font-weight: 600;
            text-rendering: optimizeLegibility; /* 优化字体渲染 */
            -webkit-font-smoothing: subpixel-antialiased; /* Mac优化 */
        }
        .json-escape {
            color: #00cecb;
            font-weight: bold;
        }
        .json-number { 
            color: #6c5ce7;
            font-weight: 600;
            text-rendering: optimizeLegibility; /* 优化字体渲染 */
            -webkit-font-smoothing: subpixel-antialiased; /* Mac优化 */
        }
        .json-boolean { 
            color: #ff8c00;
            font-weight: 600;
            text-rendering: optimizeLegibility; /* 优化字体渲染 */
            -webkit-font-smoothing: subpixel-antialiased; /* Mac优化 */
        }
        .json-null {
            color: #999;
            font-weight: 600;
            text-rendering: optimizeLegibility; /* 优化字体渲染 */
            -webkit-font-smoothing: subpixel-antialiased; /* Mac优化 */
        }
        .json-bracket { 
            color: #333;
            font-weight: 600;
        }
        .json-colon { 
            color: #333;
            font-weight: 600;
            margin: 0 3px;
        }

        /* 暗黑模式适配 */
        body.dark {
            --text-color: #e0e0e0;
            --bracket-color: rgb(232, 230, 230);
        }
        body.dark .json-key { color: #ff8c8c; }
        body.dark .json-string { color: #a280ff; }
        body.dark .json-number { color: #a280ff; }
        body.dark .json-boolean { color: #ff9f43; }
        body.dark .json-bracket { color: var(--bracket-color); }
        body.dark .json-colon { color: var(--bracket-color); }
        /* 修复工具栏布局 */
        .toolbar {
            height: 36px;
            background: #fff5f8;
            display: flex;
            align-items: center;
            padding: 0 12px;
            border-bottom: 1px solid #ffe6ee;
            gap: 10px;
            /* 新增关键属性 */
            flex-wrap: nowrap; /* 禁止换行 */
            overflow-x: auto; /* 横向滚动 */
        }

        .toolbar-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0; /* 防止挤压变形 */
        }

        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: #ddd;
            flex-shrink: 0;
        }

        /* 其他原有样式保持不变 */
        .toolbar-icon {
            width: 28px;
            height: 28px;
            padding: 4px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: grid;
            place-items: center;
            background: none;
            border: none;
            color: #666;
            flex-shrink: 0; /* 新增 */
        }
        .toolbar-icon:hover {
            background: rgba(0, 0, 0, 0.08);
        }
        .toolbar-icon svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }
        /* 暗黑模式适配 */
        body.dark .toolbar-divider {
            background: #555;
        }
        body.dark .toolbar{
            background: #2a2a2a;
            border-bottom: 1px solid #3a3a3a;
        }
        body.dark .toolbar-icon {
            color: #999;
        }

        body.dark .toolbar-icon:hover {
            background: rgba(255, 255, 255, 0.08);
        }
        /* 移动端优化 */
        @media screen and (max-width: 768px) {
            .code-content {
                text-size-adjust: 100%; /* 禁用字体自动调整 */
                -webkit-text-size-adjust: 100%;
            }
            
            /* 英文加粗补偿 */
            .json-key,
            .json-string,
            .json-number {
                font-weight: 700 !important;
                letter-spacing: -0.02em; /* 微调字间距 */
            }
        }

    </style>
</head>
<body>
    <div class="window" id="exportTarget">
        <div class="titlebar">
            <div class="controls">
                <div class="control close"></div>
                <div class="control minimize"></div>
                <div class="control maximize"></div>
            </div>
            <div class="filename">business_card.json</div>
        </div>
        <!-- 精简版工具栏 -->
        <div class="toolbar">
          <!-- 文件操作组 -->
          <div class="toolbar-group">
              <div class="toolbar-icon" title="打开文件">
                  <svg viewBox="0 0 24 24">
                      <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zm-2-2H7v-2h10v2zm-4-4H7v-2h6v2z"/>
                  </svg>
              </div>
              <div class="toolbar-icon" title="新建文件">
                  <svg viewBox="0 0 24 24">
                      <path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zm4 18H6V4h7v5h5v11zm-8-4h2v-3h3v-2h-3v-3h-2v3H9v2h3z"/>
                  </svg>
              </div>
              <div class="toolbar-icon" title="打开文件夹">
                <svg viewBox="0 0 24 24">
                    <path fill="none" stroke="currentColor" stroke-width="2.2" 
                          d="M3 5a2 2 0 012-2h4.586a1 1 0 01.707.293L11.414 5H19a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V5z"/>
                </svg>
            </div>

              <div class="toolbar-icon" title="保存文件">
                  <svg viewBox="0 0 24 24">
                      <path d="M17 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                  </svg>
              </div>
          </div>

          <!-- 分隔线 -->
          <div class="toolbar-divider"></div>

          <div style="flex-grow: 1"></div>

          <!-- 右侧功能组 -->
          <div class="toolbar-group">
              <div class="toolbar-icon" title="运行">
                <svg viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                </svg>
            </div>
            <div class="toolbar-icon" title="调试">
                <svg viewBox="0 0 24 24">
                    <path d="M20 8h-2.81c-.45-.78-1.07-1.45-1.82-1.96L17 4.41 15.59 3l-2.17 2.17C12.96 5.06 12.49 5 12 5s-.96.06-1.41.17L8.41 3 7 4.41l1.62 1.63C7.88 6.55 7.26 7.22 6.81 8H4v2h2.09c-.05.33-.09.66-.09 1v1H4v2h2v1c0 .34.04.67.09 1H4v2h2.81c1.04 1.79 2.97 3 5.19 3s4.15-1.21 5.19-3H20v-2h-2.09c.05-.33.09-.66.09-1v-1h2v-2h-2v-1c0-.34-.04-.67-.09-1H20V8zm-6 8h-4v-2h4v2zm0-4h-4v-2h4v2z"/>
                </svg>
            </div>
              <div class="toolbar-icon" title="终端">
                  <svg viewBox="0 0 24 24">
                      <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8h16v10zm-2-1h-6v-2h6v2z"/>
                  </svg>
              </div>
              <div class="toolbar-icon" title="设置">
                  <svg viewBox="0 0 24 24">
                      <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.09-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                  </svg>
              </div>
          </div>
      </div>
        <div class="editor">
            <div class="line-numbers" id="lineNumbers">
                <!-- 行号通过JS动态生成 -->
            </div>
            <div class="code-content" id="codeContent">
                <!-- JSON内容通过JS动态生成 -->
            </div>
        </div>
    </div>
    <div>
    <button class="theme-toggle" onclick="toggleTheme()">🌙 切换暗黑模式</button>
    <button class="theme-toggle" onclick="exportToPNG()" style="margin-left: 50px;"><svg viewBox="2 0 20 22" style="height: 16;width: 16;">
      <path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2z"/></svg> 导出图片</button>
    </div>
    <div class="input-container">
      <div id="inputRows">
          <div class="input-row">
              <div class="input-group">
                  <input type="text" placeholder="Key" class="json-key">
                  <input type="text" placeholder="Value" class="json-value">
              </div>
              <button class="remove-btn" onclick="removeRow(this)">×</button>
          </div>
      </div>
      <div class="btn-group">
          <button class="add-btn" onclick="addNewRow()">➕ 添加字段</button>
      </div>
  </div>
    <script>
        // 导出功能实现
        async function exportToPNG() {
            try {
                const element = document.getElementById('exportTarget');
                
                // 配置参数
                const options = {
                    scale: 2,           // 提高分辨率
                    useCORS: true,      // 处理跨域内容
                    backgroundColor: null,
                    windowHeight: element.scrollHeight,
                    onclone: (clonedDoc) => {
                        // 可选：隐藏不需要的元素
                        clonedDoc.querySelector('.theme-toggle').classList.add('screenshot-hide');
                    }
                };

                // 生成canvas
                const canvas = await html2canvas(element, options);
                // // 创建临时canvas处理边缘
                // const tempCanvas = document.createElement('canvas');
                // const ctx = tempCanvas.getContext('2d');
                // tempCanvas.width = canvas.width;
                // tempCanvas.height = canvas.height;

                // // 绘制抗锯齿圆角
                // ctx.beginPath();
                // ctx.roundRect(0, 0, canvas.width, canvas.height, 20 * (canvas.width/480));
                // ctx.clip();
                // ctx.drawImage(canvas, 0, 0);

                // // 边缘像素修复
                // const imageData = ctx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                // const data = imageData.data;
                // for(let i = 0; i < data.length; i += 4) {
                //     if(data[i+3] < 10) { // 透明度低于0.04的像素
                //         data[i] = 0;     // R
                //         data[i+1] = 0;   // G
                //         data[i+2] = 0;   // B
                //         data[i+3] = 0;   // A
                //     }
                // }
                // ctx.putImageData(imageData, 0, 0);
                // 转换为PNG
                const imgData = canvas.toDataURL('image/png');
                
                // 触发下载
                const link = document.createElement('a');
                link.download = `editor-${Date.now()}.png`;
                link.href = imgData;
                link.click();
                
            } catch (error) {
                console.error('导出失败:', error);
                alert('导出失败，请检查控制台查看详情');
            }
        }
        // 改进后的高亮处理函数
        function highlightJSON(line) {
            // 第一步：匹配键名字符串（包含转义）
            let output = line.replace(
                /"((?:\\["\\]|[^"\\])*)"(?=\s*:)/g, 
                '<span class="json-key">"$1"</span>'
            );

            // 阶段二：处理值字符串（排除键名区域）
            output = output.replace(
                /(<span[^>]+>)?("((?:\\["\\]|[^"\\])*)")(<\/span>)?/g,
                (match, prefix, fullStr, content, suffix) => {
                    // 如果已经属于键名区域则跳过
                    if (prefix && prefix.includes('json-key')) return match;
                    return `${prefix || ''}<span class="json-string">${fullStr}</span>${suffix || ''}`;
                }
            );

            // 阶段三：处理其他值类型
            return output
                .replace(/: /g, '<span class="json-colon">:</span> ')
                .replace(/\b(true|false|null)\b(?!<\/span)/g, '<span class="json-boolean">$1</span>')
                .replace(/(?<!<\/span>)(-?\d+(?:\.\d+)?)\b/g, '<span class="json-number">$1</span>')
                .replace(/[{}[\],]/g, '<span class="json-bracket">$&</span>')
                .replace(/\\(.)/g, '<span class="json-escape">\\$1</span>');
        }

        // 加强版HTML转义
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;");
        }
      function getInputData() {
            const rows = document.querySelectorAll('.input-row');
            const data = {};
            
            rows.forEach(row => {
                const key = row.querySelector('.json-key').value;
                const value = parseValue(row.querySelector('.json-value').value);
                if(key) data[key] = value;
            });
            
            return data;
        }

        function parseValue(value) {
          try {
                if (/(?:^|,)(?:\s*"(?:\\"|[^"])*"\s*)(?:,|$)/.test(value)) {
                    try {
                        // 尝试解析为数组
                        return JSON.parse(`[${value}]`);
                    } catch {
                        // 解析失败时保持原样
                        return value;
                    }
                }
                // 尝试解析为JSON值
                if(value === 'true') return true;
                if(value === 'false') return false;
                if(!isNaN(value) && value !== '') return Number(value);
                return JSON.parse(`"${value}"`);
            } catch {
                // 纯文本处理
                return value;
            }
            // 简单类型检测
            return value;
        }

        function addNewRow() {
            const newRow = document.createElement('div');
            newRow.className = 'input-row';
            newRow.innerHTML = `
                <div class="input-group">
                    <input type="text" placeholder="Key" class="json-key">
                    <input type="text" placeholder="Value" class="json-value">
                </div>
                <button class="remove-btn" onclick="removeRow(this)">×</button>
            `;
            document.getElementById('inputRows').appendChild(newRow);
        }

        function removeRow(btn) {
            btn.closest('.input-row').remove();
            updateJSON();
        }

        // 修改更新JSON的逻辑
        function updateJSON() {
            generateJSONContent(getInputData());
        }

        // 为所有输入框添加事件监听
        document.addEventListener('input', (e) => {
            if(e.target.matches('.json-key, .json-value')) {
                updateJSON();
            }
        });

        // 初始化时添加示例数据
        document.querySelector('.json-key').value = 'name';
        document.querySelector('.json-value').value = '冰糖zz';
        addNewRow();
        document.querySelectorAll('.json-key')[1].value = 'title';
        document.querySelectorAll('.json-value')[1].value = '"Developer","Astrologer"';
        addNewRow();
        document.querySelectorAll('.json-key')[2].value = 'email';
        document.querySelectorAll('.json-value')[2].value = 'lwblyk@qq.com';
        updateJSON();
        // JSON数据
        const profileData = {
            "name": "冰糖zz",
            "title": ["Developer","Astrologer"],
            "email": "lwblyk@qq.com"
        };

        // 生成JSON内容（修复后的版本）
        function generateJSONContent(data) {
            const jsonString = JSON.stringify(data, null, 2);
            const lines = jsonString.split('\n');
            
            // 清空现有内容
            lineNumbers.innerHTML = '';
            codeContent.innerHTML = '';

            lines.forEach((line, index) => {
                // 添加行号
                const lineNumber = document.createElement('div');
                lineNumber.className = 'line-number';
                lineNumber.textContent = index + 1;
                lineNumbers.appendChild(lineNumber);

                // 处理代码行
                const codeLine = document.createElement('div');
                codeLine.className = `json-line ${getIndentClass(line)}`;
                // 安全处理流程
                const processedLine = line
                    .replace(/&/g, "&amp;")  // 仅转义必要字符
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    // .replace(/ /g, '&nbsp;');

                // 应用高亮
                codeLine.innerHTML = highlightJSON(processedLine);
                codeContent.appendChild(codeLine);
            });
        }

        // 获取缩进类名
        function getIndentClass(line) {
            const indent = line.match(/^\s+/)?.[0].length || 0;
            return indent >= 4 ? 'indent-' + (indent / 2) : '';
        }

        // 主题切换
        function toggleTheme() {
            document.body.classList.toggle('dark');
            const btn = document.querySelector('.theme-toggle');
            btn.textContent = document.body.classList.contains('dark') 
                ? "☀️ 切换亮色模式" 
                : "🌙 切换暗黑模式";
        }

        // 初始化
        generateJSONContent(profileData);
    </script>
</body>
</html>